## 概念
### 数据块
磁盘读写的最小单位是数据块，文件系统块大小可以是磁盘块的整数倍(磁盘块一般为512字节)。
HDFS的块默认是128MB，目的是为了最小化寻址开销，当块足够大时，磁盘传输数据的时间会明显大于定位这个块开始位置所需的时间。但是也不会设置过大，因为MapReduce中的map任务通常
一次只处理一个块中的数据，过大就会大致task数量过少，运行速度降低。
### namenode和datanode
#### namenode
管理文件系统的命名空间，它维护着文件系统树以及整棵树内的所有文件和目录。这些信息以两个文件形式永久保存在本地磁盘上：命名空间镜像文件和编辑日志文件。namenode也记录着每个
文件中各个块所在的数据节点信息，但它并不会永保存块信息，因为这些信息会在系统启动时根据数据节点信息重建。   
#### datanode
文件系统的工作节点，它们根据需要存储并检索数据块(受客户端或namenode调度)，并且定期向namenode发送它们所存储的块的列表。   
**namenode实现容错**
>* 备份那些组成文件系统元数据持久状态的文件，持久状态写入本地磁盘的同时，写入其他文件系统(NFS),实时同步的，原子操作。  
>* 使用辅助namenode，定期合并编辑日志与命名空间镜像，保存状态值后于主节点。

#### 块缓存
频繁访问的文件，其对应的块可能被显示地缓存在datanode的内存中，以堆外块缓存的形式存在。

#### HDFS的高可用性
使用一对活动-备用namenode：
>* namenode之间通过高可用共享存储实现编辑日志的共享
>* datanode需要同时向两个namenode发送数据块处理报告，因为数据块的映射信息存储在namenode的内存中
>* 客户端使用特定的机制来处理datanode的失效问题
>* 备用namenode为活动的namenode命名空间设置周期性检查点。

QJM(群体日志管理器)以一组日志节点的形式运行，每一次编辑必须写入多数的日志节点。同一时间QJM仅允许一个namenode向编辑日志中写入数据。
故障转移控制器负责将活动namenode转移为备用namenode(默认使用zk)。  

### 数据流剖析
>* 文件读取：DistributedFileSystem通过RPC调用namenode，以确定文件起始块的位置，对于每一个块，namenode返回存有该块副本的datanode地址(根据集群网络拓扑结构排序)，返回一个FSDataInputStream对象；  
>* 文件写入：DistributedFileSystem通过RPC调用namenode，在文件系统的命名空间创建一个文件，namenode执行检查确保文件不存在以及客户端拥有执行该文件的执行权限，返回一个FSDataOutputStreawm对象。

文件写入三个概念：**数据队列、确认队列、管线**  

#### 一致模型
文件系统的一致模型描述了文件读写的数据可见性，新建一个文件在文件系统的命名空间中立即可见，但是写入的内容不能保证立即可见，即使数据流以及刷新并存储。当前正在写入的块对其他的reader不可见，写入后就可见(通过hflush方法能保证立即可见)。





